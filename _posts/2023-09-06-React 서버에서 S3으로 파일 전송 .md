React 서버에서 S3으로 파일 전송
=====================

파일 업로드 시 DB 사용
--------------

*   S3는 동일한 이름 덮어쓰기 함
    
    *   이전 파일이 없어지지 않도록 하기 위해서는 새로 업로드 되는 파일이 새로운 이름을 갖거나 이름이 중복 될 수 없도록 업로드 하는 쪽에서 처리 필요
    
    *   업로드 하는 쪽에서 처리 시 처음 이름과 변경된 이름 저장 필요
        *   이렇게 하지 않으면 매번 S3 접속하여 모든 이름 가져와야 함
    
    *   서버가 파일을 업로드 하는 경우 클라이언트가 서버에게 파일을 전송하고 서버가 다시 저장소에 전송하는 구조 ⇒ 트래픽 증가
    
    *   클라이언트 처리는 보안에 취약함

파일 업로드 처리 위치
------------

### client vs server

React 실행
--------

*   yarn create react-app app

*   npm install aws-sdk

*   yarn add aws-sdk

app.js 수정
---------

    import React ,{useState} from 'react';
    import AWS from 'aws-sdk'
    
    const S3_BUCKET ='eunhabucket';
    const REGION ='ap-northeast-1';
    
    AWS.config.update({
      accessKeyId: 'AKIAZ6BCJVVQBLVO3F5V',
      secretAccessKey: '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'
    })
    
    //저장할 버킷 객체 생성
    const myBucket = new AWS.S3({
      params: { Bucket: S3_BUCKET},
      region: REGION,
    })
    
    function App() {
      //파일 업로드 진행 상태 저장할 상태 변수
      const [progress , setProgress] = useState(0);
      
      //업로드 파일 저장할 상태 변수
      const [selectedFile, setSelectedFile] = useState(null);
      
      // 파일의 선택을 변경 시 호출 함수
      const handleFileInput = (e) => {
        // 선택 파일을 실제로는 selectedFile에 저장
        setSelectedFile(e.target.files[0]);
      }
      // 전송 누를 때 호출되는 함수
      const uploadFile = (file) => {
        const params = {
        ACL: 'public-read',
        Body: file,
        Bucket: S3_BUCKET,
        Key: file.name
        };
    
      myBucket.putObject(params).on('httpUploadProgress', (evt) => {
      //전송 중간마다 전송 비율을 출력
        setProgress(Math.round((evt.loaded / evt.total) * 100))
      }).send((err) => {
      if (err) console.log(err)
      })
    }
    
    return <div>
      <div>Native SDK File Upload Progress is {progress}%</div>
        <input type="file" onChange={handleFileInput}/>
        <button onClick={() => uploadFile(selectedFile)}> Upload to S3</button>
      </div>
    }
    
    export default App;

리액트 앱에서 이미지 올리기
---------------

[![](React%20%E1%84%89%E1%85%A5%E1%84%87%E1%85%A5%E1%84%8B%E1%85%A6%E1%84%89%E1%85%A5%20S3%E1%84%8B%E1%85%B3%E1%84%85%E1%85%A9%20%E1%84%91%E1%85%A1%E1%84%8B%E1%85%B5%E1%86%AF%20%E1%84%8C%E1%85%A5%E1%86%AB%E1%84%89%E1%85%A9%E1%86%BC%20d5228b39d3fe4257b4b0ec0d87c266aa/Untitled.png)](React%20%E1%84%89%E1%85%A5%E1%84%87%E1%85%A5%E1%84%8B%E1%85%A6%E1%84%89%E1%85%A5%20S3%E1%84%8B%E1%85%B3%E1%84%85%E1%85%A9%20%E1%84%91%E1%85%A1%E1%84%8B%E1%85%B5%E1%86%AF%20%E1%84%8C%E1%85%A5%E1%86%AB%E1%84%89%E1%85%A9%E1%86%BC%20d5228b39d3fe4257b4b0ec0d87c266aa/Untitled.png)

S3 버킷에서 확인 가능
-------------