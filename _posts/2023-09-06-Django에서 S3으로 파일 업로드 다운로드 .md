Django에서 S3으로 파일 업로드 및 다운로드
=========================

----------------------------

*   가상환경에서 필요한 패키지 설치
    
        #가상환경 만들기
        python -m venv venv
        
        #가상환경 시작
        venv\Scripts\activate.bat
        
        #필요 패키지 설치
        #pillow는 이미지 파일을 DB에 활용 하기 위함
        pip install django mysqlclient Pillow django-bootstrap4
    

*   django 프로젝트와 앱 만들기
    
        #프로젝트 생성
        django-admin startproject project .
        
        #어플리케이션 생성
        python manage.py startapp application
    

*   project/setting.py 수정
    
    *   IP
        
            ALLOWED_HOSTS = ["0.0.0.0"]
        
    
    *   앱 등록
        
            INSTALLED_APPS = [
                "django.contrib.admin",
                "django.contrib.auth",
                "django.contrib.contenttypes",
                "django.contrib.sessions",
                "django.contrib.messages",
                "django.contrib.staticfiles",
                "application",
                "bootstrap4",
            ]DATABASES = {
                "default": {
                    "ENGINE": "django.db.backends.mysql",
                    "NAME":"eunhaDB",
                    "USER":"eunha",
                    "PASSWORD":"beh240957",
                    "HOST":"eunhamysql.czzsyrzebsxi.ap-northeast-1.rds.amazonaws.com",
                    "PORT":"3306"
                            }
            }
        
    
    *   데이터베이스 - 아마존의 RDS(mysql)와 연결
        
            DATABASES = {
                "default": {
                    "ENGINE": "django.db.backends.mysql",
                    "NAME":"eunhaDB",
                    "USER":"eunha",
                    "PASSWORD":"beh240957",
                    "HOST":"eunhamysql.czzsyrzebsxi.ap-northeast-1.rds.amazonaws.com",
                    "PORT":"3306"
                            }
            }
        

*   브라우저에서 실행 되는지 확인
    
    [![](Django%E1%84%8B%E1%85%A6%E1%84%89%E1%85%A5%20S3%E1%84%8B%E1%85%B3%E1%84%85%E1%85%A9%20%E1%84%91%E1%85%A1%E1%84%8B%E1%85%B5%E1%86%AF%20%E1%84%8B%E1%85%A5%E1%86%B8%E1%84%85%E1%85%A9%E1%84%83%E1%85%B3%20%E1%84%83%E1%85%A1%E1%84%8B%E1%85%AE%E1%86%AB%E1%84%85%E1%85%A9%E1%84%83%E1%85%B3%200724dd5d7a9c41338412a92cadc9234c/Untitled.png)](Django%E1%84%8B%E1%85%A6%E1%84%89%E1%85%A5%20S3%E1%84%8B%E1%85%B3%E1%84%85%E1%85%A9%20%E1%84%91%E1%85%A1%E1%84%8B%E1%85%B5%E1%86%AF%20%E1%84%8B%E1%85%A5%E1%86%B8%E1%84%85%E1%85%A9%E1%84%83%E1%85%B3%20%E1%84%83%E1%85%A1%E1%84%8B%E1%85%AE%E1%86%AB%E1%84%85%E1%85%A9%E1%84%83%E1%85%B3%200724dd5d7a9c41338412a92cadc9234c/Untitled.png)
    

*   화면을 만들기 위해 보여지는 템플릿 엔진 폴더 생성
    *   mkdir templates

*   업로드된 파일이 저장될 디렉토리 생성
    *   mkdir media

*   모델 생성 (application/models.py)
    
        from django.db import models
        
        # Create your models here.
        class FileUpload(models.Model):
            title=models.TextField(max_length=40,null=True)
            imgfile=models.ImageField(upload_to="",
                                      blank=True,null=True)
            content=models.TextField()
            
            def __str__(self):
                return self.title
    

*   마이그레이션
    
        python manage.py makemigrations
        python manage.py migrate
    

*   모델에 해당하는 form 생성 (application/forms.py)
    
        from django.forms import ModelForm
        from .models import FileUpload
        
        class FileUploadForm(ModelForm):
            class Meta:
                model=FileUpload
                fields=["title","imgfile","content"]
    

*   요청 처리(service 계층) 함수 소유 [views.py](http://views.py) 수정
    
        #render = 화면에 그리는 것
        #redirect = 작업 완료 후 새로운 요청 생성
        #forwarding은 새로고침 하면 작업 다시 시작
        #redirect는 새로고침 하면 화면만 다시 출력
        #회원가입 같은 경우는 redirect로 진행해야 함
        #get은 보통 forwarding
    
        from django.shortcuts import render, redirect
        from .forms import FileUploadForm
        from .models import FileUpload
        
        def fileUpload(request):
            if request.method == 'POST':
                #파라미터 있으면 읽기
                title = request.POST['title']
                content = request.POST['content']
                img = request.FILES["imgfile"]
                fileupload = FileUpload(
                title=title,
                content=content,
                imgfile=img,
                )
        
                #model 생성
                fileupload.save()
                
                #결과 리턴
                #새로 고침 후 다시 반복되면 안되므로 redirect 수행
                return redirect('fileupload')
            else:
                #데이터 생성
                fileuploadForm = FileUploadForm
                context = {
                'fileuploadForm': fileuploadForm,
                }
                #출력할 뷰와 데이터를 하나로 묶어서 넘김
                return render(request, 'fileupload.html', context)
    

*   화면 출력에 공통으로 사용할 base.html 파일을 tempates 폴더에 생성
    
        {% load static %}
        <!DOCTYPE html>
        <html lang="ko">
        <head>
        	<meta charset="UTF-8">
        	<link rel="stylesheet" 
        	href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" 
        	integrity="sha384-
        	ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" 
        	crossorigin="anonymous">
        	<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-
        	q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" 
        	crossorigin="anonymous"></script>
        	<script 
        	src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" 
        	integrity="sha384-
        	UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" 
        	crossorigin="anonymous"></script>
        	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" 
        	integrity="sha384-
        	JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" 
        	crossorigin="anonymous"></script>
        </head>
        <body>
        {% block content %}
        {% endblock %}
        </body>
        </html>
    
    *   style sheet나 js의 경우 위 변조 확인하기 위해 integritiy 사용

*   실제 업로드 화면으로 사용할 fileupload.html 파일을 tempates 디렉토리에 생성
    
        {% extends 'base.html' %}
        {% load static %}
        {% load bootstrap4 %}
        {% block content %}
        <div class="container">
            <form method="POST" action="{% url 'fileupload' %}" enctype="multipart/form-data">
                {% csrf_token %}
                {% bootstrap_form fileuploadForm %}
                <input type="submit" class="btn btn-primary col-12" value="제출">
            </form>
        </div>
        {% endblock%}
    
    *   클라이언트에서 파일 전송 시 form 사용하는 경우는 enctype을 반드시 "multipart/form-data”로 지정해야 함
    
    *   클라이언트에서 서버로 폼 전송 시 반드시 csrf\_token 설정
        
        *   이 폼 전송받은 클라이언트를 증명하기 위한 token 값
        
        *   이 값 사용하지 않으면 다른곳에서 url 복하하거나 자바스크립트 이용 임의 데이터 전송 가능
    
    *   {% bootstrap\_form fileuploadForm %}
        
        *   장고나 스프링 같은 프레임워크는 폼을 자동 생성 기능 있음
        
        *   id, name 등이 자동 생성됨
        
        *   클라이언트에서 name 이용 서버 전송하는데 직접 이름 설정 시 실수 가능성 있음

*   [urls.py](http://urls.py) 파일에 url 작성 (controller)
    
        from django.contrib import admin
        from django.urls import path
        from fileupload import views
        
        urlpatterns = [
            path("admin/", admin.site.urls),
            path('fileupload/',views.fileUpload,name='fileupload')
        ]
    
    *   static: 정적 파일 중 화면 출력과 관련된 파일 - html, css, javascript
    
    *   media: 정적 파일 중 리소스에 해당하는 파일

*   [http://127.0.0.1:8000/fileupload/](http://127.0.0.1:8000/fileupload/) 브라우저에서 img POST 할 시 데이터 베이스와 media 폴더에 데이터/이미지 업로드 됨
    *   로컬에 파일 저장 시 문제점
        
        *   로컬의 프로젝트 디렉토리에만 저장 가능 (절대경로가 필요하므로)
            *   다른곳에서 실행시에는 경로 수정 필요
        
        *   TOMCAT과 같은 WAS 이용 시 IDE 이용하여 테스트 할 떄, 배포 후 실행 시 경로가 다름
        
        *   확장이 어려움
        
        *   따라서 최근에는 클라우드 파일 서버 별도로 생성하여 저장

S3에 데이터 업로드/다운로드
----------------

*   AWS 서비스 안에서도 계정이 필요한 경우 있음
    *   VPC 안 묶이는 경우

*   S3 접근 권한 정책이 public으로 가능해야 하고 할 수 있는 작업 설정 필요

*   웹 앱이 ajax나 fetch api 같은 브라우저 요청일 경우 cors 설정도 필요함

*   장고에서 파일 업로드가 쉬움

*   연결에 필요한 정보
    
    *   name: eunhabucket
    
    *   region: ap-northeast-1
    
    *   access key와 secret access key
        
        Access key ID
        
        Secret access key
        
        AKIAZ6BCJVVQBLVO3F5V
        
        azxzdpSjn2kty915bYDsVq0jxmA48tMeey8B0U0m
        

*   패키지 설치
    
    *   pip install boto3 #aws와 연동 위한 패키지, lambda 사용 시에도 필요함
    
    *   pip install django-storages #장고 앱 파일 저장소를 외부와 연결 시 사용

*   [settings.py](http://settings.py)파일에 AWS와 장고 스토리지 설정 추가
    
        # AWS Setting
        AWS_REGION = 'ap-northeast-1' #AWS서버의 지역
        AWS_STORAGE_BUCKET_NAME = 'eunhabucket' #생성한 버킷 이름
        AWS_ACCESS_KEY_ID = 'AKIAZ6BCJVVQBLVO3F5V' #액서스 키 ID
        AWS_SECRET_ACCESS_KEY = 'azxzdpSjn2kty915bYDsVq0jxmA48tMeey8B0U0m' 
        
        AWS_S3_CUSTOM_DOMAIN = '%s.s3.%s.amazonaws.com' % (AWS_STORAGE_BUCKET_NAME, AWS_REGION)
        
        # Static Setting
        STATIC_URL = "https://%s/static/" % AWS_S3_CUSTOM_DOMAIN
        STATICFILES_STORAGE = 'storages.backends.s3boto3.S3Boto3Storage'
        
        MEDIA_URL = "https://%s/meida/" % AWS_S3_CUSTOM_DOMAIN
        DEFAULT_FILE_STORAGE = 'storages.backends.s3boto3.S3Boto3Storage'
    

*   연결 확인
    *   [http://127.0.0.1:8000/fileupload/](http://127.0.0.1:8000/fileupload/) 브라우저에서 img POST 할 시 S3 버킷에 데이터/이미지 업로드 됨

*   이름 중복 될 경우 덮어쓰기 됨
    
    *   저장 내용이 업데이트인지 새로 추가하는 것인지를 확인 필요함
        *   모델 서비스는 업데이트
    
    *   덮어씌우지 않으려면 파일명에 중복 가능성 없는 문자열 부여 필요
        
        *   UUID
            
            *   uuid 기능 추가 한 views.py
            
                from django.shortcuts import render, redirect
                from .forms import FileUploadForm
                from .models import FileUpload
                import uuid
                
                
                def fileUpload(request):
                    if request.method == 'POST':
                        #파라미터 있으면 읽기
                        title = request.POST['title']
                        content = request.POST['content']
                        img = request.FILES["imgfile"]
                
                        #확장자와 파일 이름 사이 uuid 추가
                        idx=img.name.rfind(".")
                        if idx != -1:
                            img.name=img.name[:idx]+str(uuid.uuid4())+img.name[idx:]
                        else:
                            img.name=img.name+str(uuid.uuid4())
                
                        fileupload = FileUpload(
                        title=title,
                        content=content,
                        imgfile=img,
                        )
                
                        #model 생성
                        fileupload.save()
                        
                        #결과 리턴
                        #새로 고침 후 다시 반복되면 안되므로 redirect 수행
                        return redirect('fileupload')
                    else:
                        #데이터 생성
                        fileuploadForm = FileUploadForm
                        context = {
                        'fileuploadForm': fileuploadForm,
                        }
                        #출력할 뷰와 데이터를 하나로 묶어서 넘김
                        return render(request, 'fileupload.html', context)
            
        
        *   Time Stamp
            
            *   로드밸런싱 시에는 주의 필요
            
            *   ID 별로 디렉토리 별도 생성하여 timestamp 이용 (memo 서비스)

### 데이터 다운 기능 추가

*   [views.py](http://views.py)에 추가 함수
    
        def main(request):
            pictures = FileUpload.objects.all()
            return render(request, 'main.html', {'result': pictures})
        
        def fileUpload(request):
            if request.method == 'POST':
        
        			return redirect('/') ##이부분만 수정
    

*   templatesmain.html 추가
    
        <!DOCTYPE html>
        <html lang="en">
        	<head>
        		<meta charset="UTF-8">
        		<title>Title</title>
        	</head>
        	<body>
        		{% if result %}
        		{% for picture in result %}
        		<img width="200" src="https://eunhabucket.s3.ap-northeast-1.amazonaws.com/{{ picture.imgfile }}">
        		{% endfor %}
        		{% endif %}
        	</body>
        </html>
    

*   [urls.py](http://urls.py) 수정
    
        urlpatterns = [
        	path('', views.main), #이 코드 추가
        ]
    

*   [localhost:8000](http://localhost:8000) 접속하여 확인
    
    [![](Django%E1%84%8B%E1%85%A6%E1%84%89%E1%85%A5%20S3%E1%84%8B%E1%85%B3%E1%84%85%E1%85%A9%20%E1%84%91%E1%85%A1%E1%84%8B%E1%85%B5%E1%86%AF%20%E1%84%8B%E1%85%A5%E1%86%B8%E1%84%85%E1%85%A9%E1%84%83%E1%85%B3%20%E1%84%83%E1%85%A1%E1%84%8B%E1%85%AE%E1%86%AB%E1%84%85%E1%85%A9%E1%84%83%E1%85%B3%200724dd5d7a9c41338412a92cadc9234c/Untitled%201.png)](Django%E1%84%8B%E1%85%A6%E1%84%89%E1%85%A5%20S3%E1%84%8B%E1%85%B3%E1%84%85%E1%85%A9%20%E1%84%91%E1%85%A1%E1%84%8B%E1%85%B5%E1%86%AF%20%E1%84%8B%E1%85%A5%E1%86%B8%E1%84%85%E1%85%A9%E1%84%83%E1%85%B3%20%E1%84%83%E1%85%A1%E1%84%8B%E1%85%AE%E1%86%AB%E1%84%85%E1%85%A9%E1%84%83%E1%85%B3%200724dd5d7a9c41338412a92cadc9234c/Untitled%201.png)